#!/bin/sh

if [ "$(git config --get hooks.autoformat)" = "true" ]; then
    # Auto-format mode: format and stage only the files that changed
    files_to_format=$(uv run ruff format --check . 2>&1 | grep "^Would reformat:" | sed 's/^Would reformat: //')
    if [ -n "$files_to_format" ]; then
        printf '%s\n' "$files_to_format" | xargs -d '\n' uv run ruff format
        printf '%s\n' "$files_to_format" | xargs -d '\n' git add
    fi
else
    # Check mode: fail if not formatted
    uv run ruff format --check .
fi

# Lint and type check (only for AI agents)
if [ "$(git config --get hooks.strictChecks)" = "true" ]; then
    uv run ruff check .
    uv run basedpyright .
fi
